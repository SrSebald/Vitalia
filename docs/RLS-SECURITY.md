# üîê Row Level Security (RLS) - Gu√≠a Completa

## üìã Tabla de Contenidos
- [¬øQu√© es RLS?](#qu√©-es-rls)
- [Arquitectura de Seguridad](#arquitectura-de-seguridad)
- [Pol√≠ticas Implementadas](#pol√≠ticas-implementadas)
- [C√≥mo Usar RLS en tu C√≥digo](#c√≥mo-usar-rls-en-tu-c√≥digo)
- [Instalaci√≥n y Configuraci√≥n](#instalaci√≥n-y-configuraci√≥n)
- [Ejemplos de Uso](#ejemplos-de-uso)
- [Troubleshooting](#troubleshooting)

---

## ¬øQu√© es RLS?

**Row Level Security (RLS)** es una caracter√≠stica de PostgreSQL que permite controlar el acceso a filas individuales de una tabla bas√°ndose en pol√≠ticas de seguridad. 

### Beneficios:

‚úÖ **Seguridad a nivel de base de datos** - Independiente del c√≥digo de la aplicaci√≥n  
‚úÖ **Protecci√≥n contra bugs** - Aunque tu c√≥digo tenga errores, RLS protege los datos  
‚úÖ **Multi-tenancy** - Usuarios solo ven sus propios datos autom√°ticamente  
‚úÖ **Cumplimiento de privacidad** - GDPR, HIPAA, etc.  
‚úÖ **Defensa en profundidad** - Capa adicional de seguridad

### ‚ö†Ô∏è Lo que RLS NO hace:

‚ùå No reemplaza la autenticaci√≥n  
‚ùå No funciona sin establecer el contexto de usuario  
‚ùå No protege contra ataques de fuerza bruta  
‚ùå No cifra datos en reposo

---

## Arquitectura de Seguridad

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Usuario Autenticado                   ‚îÇ
‚îÇ                     (Supabase / JWT)                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   Next.js Middleware                     ‚îÇ
‚îÇ                (Verifica autenticaci√≥n)                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     API Routes                           ‚îÇ
‚îÇ          setCurrentUser(sql, userId)                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    PostgreSQL                            ‚îÇ
‚îÇ              RLS Policies Active                         ‚îÇ
‚îÇ    ‚Ä¢ Filtra autom√°ticamente filas por usuario           ‚îÇ
‚îÇ    ‚Ä¢ Bloquea INSERT/UPDATE/DELETE no autorizados        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Pol√≠ticas Implementadas

### üóÇÔ∏è Por Tabla

#### 1. **profiles** - Perfiles de Usuario
```sql
‚úì SELECT: Solo ver tu propio perfil
‚úì INSERT: Solo crear tu propio perfil
‚úì UPDATE: Solo actualizar tu propio perfil
‚úì DELETE: Solo eliminar tu propio perfil
```

#### 2. **exercises** - Ejercicios
```sql
‚úì SELECT: Ver ejercicios p√∫blicos + tus ejercicios privados
‚úì INSERT: Crear ejercicios vinculados a tu perfil
‚úì UPDATE: Solo actualizar tus propios ejercicios
‚úì DELETE: Solo eliminar tus propios ejercicios
```

#### 3. **workouts** - Entrenamientos
```sql
‚úì SELECT: Solo ver tus entrenamientos
‚úì INSERT: Solo crear tus propios entrenamientos
‚úì UPDATE: Solo actualizar tus entrenamientos
‚úì DELETE: Solo eliminar tus entrenamientos
```

#### 4. **sets** - Series de Ejercicios
```sql
‚úì SELECT: Ver series de tus entrenamientos
‚úì INSERT: Agregar series a tus entrenamientos
‚úì UPDATE: Actualizar series de tus entrenamientos
‚úì DELETE: Eliminar series de tus entrenamientos
```

#### 5. **nutrition_logs** - Registros de Nutrici√≥n
```sql
‚úì Acceso completo solo a tus propios registros
```

#### 6. **mood_logs** - Registros de Estado de √Ånimo
```sql
‚úì Acceso completo solo a tus propios registros
```

#### 7. **progress_photos** - Fotos de Progreso
```sql
‚úì Acceso completo solo a tus propias fotos
```

---

## C√≥mo Usar RLS en tu C√≥digo

### 1Ô∏è‚É£ Importar las Utilidades

```typescript
import { sql } from '@/lib/db';
import { withUserContext } from '@/lib/db/rls-helper';
```

### 2Ô∏è‚É£ Usar en API Routes

```typescript
// app/api/workouts/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { sql } from '@/lib/db';
import { withUserContext } from '@/lib/db/rls-helper';

export async function GET(request: NextRequest) {
  // 1. Obtener el userId de la sesi√≥n/JWT
  const userId = getUserFromSession(request); // Tu funci√≥n de auth
  
  if (!userId) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  // 2. Ejecutar queries con contexto de usuario
  const workouts = await withUserContext(sql, userId, async () => {
    // Todas las consultas aqu√≠ respetan RLS autom√°ticamente
    return await sql`
      SELECT * FROM workouts
      ORDER BY workout_date DESC
    `;
  });

  return NextResponse.json(workouts);
}

export async function POST(request: NextRequest) {
  const userId = getUserFromSession(request);
  const body = await request.json();

  const result = await withUserContext(sql, userId, async () => {
    // RLS verifica autom√°ticamente que user_id coincida
    return await sql`
      INSERT INTO workouts (user_id, name, workout_date)
      VALUES (${body.userId}, ${body.name}, ${body.date})
      RETURNING *
    `;
  });

  return NextResponse.json(result[0]);
}
```

### 3Ô∏è‚É£ Uso con Supabase Auth

Si usas Supabase para autenticaci√≥n:

```typescript
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

async function getUserIdFromSupabase() {
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    { cookies }
  );

  const { data: { user } } = await supabase.auth.getUser();
  return user?.id;
}

export async function GET(request: NextRequest) {
  const userId = await getUserIdFromSupabase();
  
  return withUserContext(sql, userId!, async () => {
    const data = await sql`SELECT * FROM workouts`;
    return NextResponse.json(data);
  });
}
```

---

## Instalaci√≥n y Configuraci√≥n

### Paso 1: Aplicar las Pol√≠ticas RLS

```bash
# Opci√≥n A: Usar el script npm
bun run db:rls

# Opci√≥n B: Ejecutar manualmente
bun run scripts/apply-rls.ts
```

### Paso 2: Verificar que se Aplicaron

```bash
# Conectar a PostgreSQL
psql $DATABASE_URL

# Ver pol√≠ticas activas
SELECT schemaname, tablename, policyname, cmd
FROM pg_policies
WHERE schemaname = 'public'
ORDER BY tablename;

# Verificar que RLS est√° habilitado
SELECT tablename, rowsecurity
FROM pg_tables
WHERE schemaname = 'public';
```

Deber√≠as ver:
```
 tablename        | rowsecurity
------------------+-------------
 profiles         | t
 exercises        | t
 workouts         | t
 sets             | t
 nutrition_logs   | t
 mood_logs        | t
 progress_photos  | t
```

### Paso 3: Configurar tu .env

```bash
# .env
DATABASE_URL=postgresql://user:pass@localhost:5432/Vitalia
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
```

---

## Ejemplos de Uso

### Ejemplo 1: Obtener Entrenamientos del Usuario

```typescript
// app/api/my-workouts/route.ts
export async function GET(request: NextRequest) {
  const userId = await getUserId(request);

  const workouts = await withUserContext(sql, userId, async () => {
    return await sql`
      SELECT 
        w.*,
        COUNT(s.id) as total_sets
      FROM workouts w
      LEFT JOIN sets s ON s.workout_id = w.id
      GROUP BY w.id
      ORDER BY w.workout_date DESC
      LIMIT 10
    `;
  });

  return NextResponse.json({ workouts });
}
```

### Ejemplo 2: Crear un Nuevo Workout

```typescript
export async function POST(request: NextRequest) {
  const userId = await getUserId(request);
  const { profileId, name, date } = await request.json();

  const workout = await withUserContext(sql, userId, async () => {
    // RLS verifica que profileId pertenezca al usuario autenticado
    const [newWorkout] = await sql`
      INSERT INTO workouts (user_id, name, workout_date)
      VALUES (${profileId}, ${name}, ${date})
      RETURNING *
    `;
    return newWorkout;
  });

  return NextResponse.json(workout);
}
```

### Ejemplo 3: Ver Ejercicios (P√∫blicos + Propios)

```typescript
export async function GET(request: NextRequest) {
  const userId = await getUserId(request);

  const exercises = await withUserContext(sql, userId, async () => {
    // RLS autom√°ticamente filtra: is_public = true OR created_by = tu perfil
    return await sql`
      SELECT * FROM exercises
      ORDER BY name
    `;
  });

  return NextResponse.json({ exercises });
}
```

---

## Troubleshooting

### ‚ùå Error: "No rows returned"

**Problema:** Las consultas no devuelven datos

**Soluci√≥n:**
```typescript
// ‚úÖ Verificar que est√°s estableciendo el contexto
await withUserContext(sql, userId, async () => {
  // tus queries aqu√≠
});

// ‚ùå NO hagas esto:
const data = await sql`SELECT * FROM workouts`; // Sin contexto
```

### ‚ùå Error: "Permission denied"

**Problema:** No puedes insertar/actualizar datos

**Soluci√≥n:**
- Verifica que `user_id` o `created_by` coincida con el perfil del usuario
- Verifica que est√©s usando el `auth_user_id` correcto

```typescript
// ‚úÖ Correcto
const profileId = await getProfileIdByAuthUserId(sql, userId);
await sql`INSERT INTO workouts (user_id, ...) VALUES (${profileId}, ...)`;
```

### ‚ùå RLS no se est√° aplicando

**Verificar:**
```sql
-- 1. ¬øEst√° habilitado RLS?
SELECT tablename, rowsecurity FROM pg_tables WHERE schemaname = 'public';

-- 2. ¬øExisten las pol√≠ticas?
SELECT * FROM pg_policies WHERE schemaname = 'public';

-- 3. ¬øEst√°s conectado como superusuario?
SELECT current_user, usesuper FROM pg_user WHERE usename = current_user;
```

**Nota:** Los superusuarios de PostgreSQL ignoran RLS por defecto.

### üîß Deshabilitar RLS temporalmente (Desarrollo)

```sql
-- Para testing/debugging
ALTER TABLE workouts DISABLE ROW LEVEL SECURITY;

-- Volver a habilitar
ALTER TABLE workouts ENABLE ROW LEVEL SECURITY;
```

---

## üìö Recursos Adicionales

- üìñ [Documentaci√≥n PostgreSQL RLS](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)
- üìñ [Supabase RLS Guide](https://supabase.com/docs/guides/auth/row-level-security)
- üìñ [Archivos de pol√≠ticas](../scripts/rls/)

---

## üÜò Soporte

Si tienes problemas con RLS:

1. Revisa los logs de PostgreSQL: `tail -f /var/log/postgresql/postgresql.log`
2. Ejecuta queries de verificaci√≥n (ver secci√≥n Troubleshooting)
3. Revisa que las variables de entorno est√©n configuradas
4. Verifica que el `auth_user_id` sea el correcto

---

**‚ú® ¬°RLS implementado exitosamente!** Tu base de datos ahora tiene una capa adicional de seguridad robusta.

